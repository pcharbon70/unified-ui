#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

run_mix() {
  if command -v asdf >/dev/null 2>&1; then
    asdf exec mix "$@"
  else
    mix "$@"
  fi
}

has_mix_task() {
  run_mix help "$1" >/dev/null 2>&1
}

if ! command -v mix >/dev/null 2>&1 && ! command -v asdf >/dev/null 2>&1; then
  echo "pre-commit: neither 'mix' nor 'asdf' is available on PATH"
  exit 1
fi

echo "pre-commit: running test suite"
run_mix test

echo "pre-commit: running Credo"
run_mix credo --strict

if has_mix_task dialyzer; then
  echo "pre-commit: running Dialyzer"
  run_mix dialyzer
else
  echo "pre-commit: skipping Dialyzer (task not available)"
fi

echo "pre-commit: all checks passed"
